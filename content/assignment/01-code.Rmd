---
title: "Práctica 1. Procesamiento de datos en R"
subtitle: "Estadistica Multivariada - Sociología FACSO Universidad de Chile"
linktitle: "Práctica 1"
date: "2020-01-10"
class_date: "2020-04-03"
citeproc: false
bibliography: ../../static/bib/references.bib
csl: ../../static/bib/chicago-syllabus-no-bib.csl
output:
  blogdown::html_page:
    template: ../../pandoc/toc-title_html.template
    toc: true
    highlight: tango
    number_sections: FALSE
menu:
  class:
    parent: Practicas
    weight: 1
type: docs
weight: 1
editor_options:
  chunk_output_type: console
---

# Presentación

## Objetivo de la práctica

El desarrollo de esta guía tiene por objetivo revisar algunos procedimientos básicos del procesamiento de datos con R, que son necesarios para luego poder aplicar los contenidos más específicos de este curso.

En este curso vamos a distinguir **dos momentos** del trabajo con datos: procesamiento y análisis.

  - **Procesamiento** corresponde a lo que se conoce generalmente como "limpieza", es decir, realizar las modificaciones necesarias para poder efectuar los análisis. Estas modificaciones previas al análisis son necesarias ya que los datos originales con los que se va a trabajar en general no vienen perfectamente adaptados a los análisis que se quieren hacer. Por lo tanto, en cuanto a datos también hacemos la distinción entre datos originales y datos procesados.

  - **Análisis**: se relaciona principalmente con análisis descriptivos asociados a las preguntas de investigación y también modelamiento de datos para contrastar hipótesis de investigación.

Tanto el procesamiento como el análisis quedan registrados en un documento de código, en este caso de código R (por lo general, un archivo con extensión .R). El documento de código de procesamiento posee 5 partes, más una sección de identificación inicial:

0. Identificación y descripción general: Título, autor(es), fecha, información breve sobre el contenido del documento
1. Librerías principales (de R) a utilizar en el análisis
2. Carga de datos
3. Selección de variables a utilizar
4. Procesamiento de variables: en este punto, por cada variable
  - Descriptivo general
  - Recodificación de datos perdidos
  - Recodificación de valores (en caso de ser necesario)
  - Etiquetamiento /re-etiquetamiento (en caso de ser necesario)
5. Generación de base de datos procesada para el análisis.

Al final de esta práctica la idea es que cada un_ elabore y entienda su propio documento de procesamiento de datos.

En el ejemplo vamos a procesar variables de meritocracia y estatus (objetivo y subjetivo) utilizando los datos de ELSOC.

## Antecedentes de los datos a utilizar

El Estudio Longitudinal Social de Chile [(ELSOC)](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/0KIRBJ) es una encuesta desarrollada para analizar intertemporalmente la evolución del conflicto y cohesión en la sociedad chilena.

Uno de los módulos de **ELSOC** es "Desigualdad y Legitimidad". Este módulo busca estudiar las percepciones y atribuciones asociadas a las desigualdades sociales. Se ve motivado por el interés de comprender cómo las personas perciben, legitiman y reproducen las diferencias de ingresos, estatus y poder presentes en el Chile contemporáneo.

El presente ejercicio tiene por objetivo el procesar los datos para obtener las variables relevante para el estudio de la **Percepción de Meritocracia**, entendida como el grado en que los individuos consideran que su sociedad cumple con los principios de una meritocracia, es decir, que funciona como un sistema que asigna recompensas en función del esfuerzo y las habilidades.

## Tutorial de instalación de R

Para quienes no trabajan en R constantemente, va un primer tutorial abajo sobre instalación de R y RStudio, necesarios para poder desarrollar esta práctica:

<div style="width: 100%; height: 600px; overflow: hidden;">
<video  style="width: 100%;" controls>
<source src="https://www.dropbox.com/s/q0jg4pv3ihtf2qd/tutorialR_editedjc.mp4?raw=1" type="video/mp4">
</video>
</div>




# Preparacion de datos con ELSOC 2016

**Recomendación general:** cargar en el preámbulo las librerías que más se utilizan durante el análisis. Si alguna función de una librería se utiliza pocas veces, es mejor utilizar una segunda forma de acceder a las funciones sin necesidad de cargar la librería. Por ejemplo, si quiero utilizar la función para recodificar `recode` de la librería `car`:


```{r, eval=FALSE, include=TRUE}
elsoc$edcine <- car::recode(elsoc$m01, "c(1,2)=1; c(3)=2;c(4,5)=3;c(6,7)=4;c(8,9,10)=5")
```

En este caso, la lógica es librería::función, y no se requiere cargar la librería pero sí **debe estar previamente instalada**. Para esto debemos ejecutar el siguiente código.

```{r, eval=FALSE, include=TRUE}
install.packages("car")
```


## 1. Librerías

Las librerías que vamos a utilizar principalmente son dplyr (ajuste general de datos) y ...
De todas maneras se recomienda realizar un comentario con el signo `**#**` luego de la librería a cargar para recordar su contenido.

```{r message=FALSE, warning=FALSE}
library(dplyr)      # ajuste general de datos
library(sjmisc)     # descripcion de variables etiquetadas  
rm(list=ls())  # borrar todos los objetos en el environment
options(scipen=999) #sin notacion cientifica
```

## 2. Cargar base de datos

Las bases de datos se pueden cargar de un archivo local o en línea. Para este caso utilizaremos un archivo en línea que viene en formato RData: **ELSOC_W01_v3.10.RData**.

La base se agrega como un objeto al espacio de trabajo con el nombre original "`elsoc_2016`". Para facilitar los análisis se le cambia el nombre simplemente a `elsoc` con la segunda instrucción


```{r eval=TRUE}
#cargamos la base de datos desde internet
load(url("https://multivariada.netlify.com/assignment/data/original/ELSOC_W01_v3.10.RData")) 
#creamos un objeto llamado elsoc que es identico a elsoc_2016, luego eliminamos elsoc_2016
elsoc <- elsoc_2016; remove(elsoc_2016) 
```

Y realizamos un chequeo básico de la lectura de datos: nombres de las variables y tamaño de la base en términos de casos y variables (en este ejemplo, `r dim(elsoc)[1]` casos y `r dim(elsoc)[2]` variables).

```{r}
dim(elsoc) # dimension de la base
```
Y si se quiere revisar en formato de planilla de datos:

```{r}
View(elsoc)
```

# Ajuste y generación de variables

Esta parte inicial del análisis es usualmente la más tediosa y la más larga, y consiste en dejar los datos listos para ser analizados. Los procedimientos usuales son selección y renombramiento de las variables, identificación de casos perdidos, recodificaciones y generación de índices simples.


## Selección y renombre de variables

Este paso es opcional y consiste en crear un subset de datos para continuar con los análisis, en lugar de hacerlo con la base completa. Para ello:

1. Se identifica el nombre de las variables. Esto aparece en el libro de códigos y/o en el cuestionario, o también se puede hacer buscando en la base de datos mediante alguna palabra clave asociada a la pregunta. Por ejemplo, si queremos buscar variables asociadas a educación, utilizamos la función `find_var`, de `sjmisc` (entrega nombre de la variable en columna var.name)

```{r}
sjmisc::find_var(elsoc,"mensual")
```

## Datos perdidos 

* En ELSOC todos los valores -888 y -999 corresponden a valores para las categorias "No sabe" y "No responde", respectivamente.
* Decidimos dejarlas como valores perdidos (NA)
* el operador `%in%` sirve para decir "dentro de", en este caso ¿dentro de la variable encontramos valores -888 o -999? Si es VERDADERO, se transforma en un `NA`, si es falso no realiza ninguna acción. El código de abajo ejemplifica este tipo de procedimiento.


```{r, include=TRUE, eval=FALSE}
datos$variable[datos$variable %in% c(-888,-999)] <- NA
```

Entonces, aplicamos las siguientes línea de código para identificar y recodificar los datos perdidos como `NA`

```{r}
elsoc$c18_09[elsoc$c18_09 %in% c(-888,-999)]  <- NA # meritocracia esfuerzo 
elsoc$c18_10[elsoc$c18_10 %in% c(-888,-999)]  <- NA # meritocracia talento

elsoc$d01_01[elsoc$d01_01 %in% c(-888,-999)]  <- NA # estatus subjetivo
elsoc$m29[elsoc$m29 %in% c(-888,-999)]        <- NA # ingreso familiar 
elsoc$m30[elsoc$m30 %in% c(-888,-999)]        <- NA # ingreso familiar en tramos
elsoc$nhogar1[elsoc$nhogar1 %in% c(-888,-999)]<- NA # personas en el hogar
elsoc$m01[elsoc$m01 %in% c(-888,-999)] <- NA        # nivel educacional

elsoc$m0_sexo[elsoc$m0_sexo %in% c(-888,-999)] <- NA # sexo
elsoc$m0_edad[elsoc$m0_edad %in% c(-888,-999)] <- NA # edad
elsoc$c15[elsoc$c15 %in% c(-888,-999)]         <- NA # autoposicionamiento politico
```


## Recodificación de variables

**Introducción**

En el caso de trabajar con R, el ajuste de las variables pasa por atender el distinto tipo de estructura, usualmente numérico (vector) o variable categórica (factor). Esta definición establece diferencias claras; por ejemplo, no se puede hacer un promedio con un factor, y los vectores númericos no tienen etiquetas. Dado que el límite entre lo categórico y lo continuo muchas veces es más relativo en ciencias sociales, para algunas operaciones resulta más eficiente contar con variables numéricas que puedan tener etiquetas, y que luego puedan ser transformadas a factor para operaciones específicas. En R este formato intermedio se denomina "vector atómico" o "vector etiquetado".

```{r}
str(elsoc[,c(1:10)]) #observamos las primeras 10 columnas de nuestra base de datos
```


En este caso, vemos que los diez vectores se definen como "haven_labelled", que hace referencia a vectores numéricos etiquetados. Esto ocurre en el proceso de conversión mediante el paquete `haven`, que transforma de esta manera a los valores numéricos con etiqueta que vienen de Stata (.dta) o SPSS (.sav).

Los vectores que que aparecen aquí se caracterizan por una serie de atributos (attr):

- **label:** etiqueta de la variable
- **format.stata:** formato de la etiqueta de la variable
- **labels**: niveles de respuesta de la variable (values) que están numerados
- **names:** nombre de las etiquetas de los valores.

Estos atributos luego van a facilitar algunas operaciones de recodificación y de descripción de los datos.

## Recodificacion Variables percepcion de meritocracia

En ELSOC, las variables que permiten medir la percepción de las personas con respecto al funcionamiento de la meritocracia en Chile son las siguientes:

* [`c18_09`]: "Grado de acuerdo: Las personas son recompensadas por sus esfuerzos"  (1 = Totalmente en desacuerdo; 5 = Totalmente de acuerdo)
* [`c18_10`]: "Grado de acuerdo: Las personas son recompensada por su inteligencia" (1 = Totalmente en desacuerdo; 5 = Totalmente de acuerdo)

```{r}
elsoc$c18_09 <- as.numeric(elsoc$c18_09) # Nos aseguramos de convertir las escalas liker a numericas
elsoc$c18_10 <- as.numeric(elsoc$c18_10) # Nos aseguramos de convertir las escalas liker a numericas
# Variables meritocracia promedio -----------------------------------------
elsoc <- dplyr::rename(elsoc,meffort=c18_09) # cambio de nombre de la variable c18_09 a uno mas sustantivo
elsoc <- dplyr::rename(elsoc,mtalent=c18_10) # cambio de nombre de la variable c18_10 a uno mas sustantivo

# creamos un indice promedio de percepcion de meritocracia usando ambas preguntas
elsoc$merit <- (elsoc$meffort+elsoc$mtalent)/2

# re escalamos la variable de 1-5 a una de 0 a 100 (para facilitar interpretacion)
elsoc$merit <-
  (elsoc$merit-min(elsoc$merit,na.rm=T))/(max(elsoc$merit,na.rm=T)-min(elsoc$merit,na.rm=T))*100
```

## Recodificacion variable Estatus subjetivo

* [`d01_01`]: "Estatus Social Subjetivo: Donde se ubicaria ud. en la sociedad chilena" (0 = el nivel mas bajo; 10 = el nivel mas alto)

```{r, results='hold'}
elsoc$ess <- as.numeric(elsoc$d01_01) # Estatus Social Subjetivo
table(elsoc$ess)
summary(elsoc$ess)
```

## Recodificacion variables Estatus objetivo

### Ingresos del hogar

Esta variable en general tiene dos formas de preguntarse: en el monto directo en pesos, o en rangos de ingreso. Hay una tercera variante donde se pregunta por el monto directo, y quienes no responden luego se les pregunta por el rango. Este último es el caso de ELSOC. 

* [`m29`] = ¿Cuál es el ingreso mensual que usted recibe por su actividad laboral, ocupación u oficio? (Ingreso líquido, es decir, después de descuentos de impuestos, salud, previsión u otros)
* [`m30`] = A continuación le presentamos un listado de rangos de ingreso. ¿Podría usted indicarme en cuál de ellos se encuentra considerando su ingreso líquido, es decir, su ingreso después de descuentos de impuestos, salud, previsión u otros?
* [`nhogar1`] = Tamaño del hogar (en número de personas)

Como estas variables en general tienen muchos datos perdidos, para poder aprovechar la información lo ideal es combinarlas. Una posibilidad es la siguiente:

1. Crear una variable de ingresos en pesos a partir de la pregunta de rangos, mediante la imputación del promedio del rango.
2. Combinar las variables de ingreso 
(`m30` $\rightarrow$ `m29`)
3. Para tener mayor sensibilidad a las implicancias del ingreso, crear una variable de ingreso equivalente por hogar, dividiendo la variable de ingreso por el número de personas del hogar ((`m29`+`m30`)/`nhogar1`).


```{r}
summary(elsoc$m29) # ingresos total ; NA == 587
summary(elsoc$m30) # ingresos tramos
summary(elsoc$nhogar1) # tamannio del hogar

elsoc$m29[elsoc$m29==0] <- NA
# Remplazar NA por media de categorias Ingreso -------------------------------#
elsoc$mean_tramos <- NA # creamos una variable vacia
# remplazamos ...
elsoc$mean_tramos[elsoc$m30==1] <-110000
elsoc$mean_tramos[elsoc$m30==2] <-250000.5
elsoc$mean_tramos[elsoc$m30==3] <-305000.5
elsoc$mean_tramos[elsoc$m30==4] <-355000.5
elsoc$mean_tramos[elsoc$m30==5] <-400000.5
elsoc$mean_tramos[elsoc$m30==6] <-445000.5
elsoc$mean_tramos[elsoc$m30==7] <-490000.5
elsoc$mean_tramos[elsoc$m30==8] <-535000.5
elsoc$mean_tramos[elsoc$m30==9] <-585000.5
elsoc$mean_tramos[elsoc$m30==10]<-640000.5
elsoc$mean_tramos[elsoc$m30==11]<-700000.5
elsoc$mean_tramos[elsoc$m30==12]<-765000.5
elsoc$mean_tramos[elsoc$m30==13]<-845000.5
elsoc$mean_tramos[elsoc$m30==14]<-935000.5
elsoc$mean_tramos[elsoc$m30==15]<-1040000.5
elsoc$mean_tramos[elsoc$m30==16]<-1180000.5
elsoc$mean_tramos[elsoc$m30==17]<-1375000.5
elsoc$mean_tramos[elsoc$m30==18]<-1670000.5
elsoc$mean_tramos[elsoc$m30==19]<-2275000.5
elsoc$mean_tramos[elsoc$m30==20]<-3726106
table(elsoc$mean_tramos) # chequeamos

elsoc$m29 <- ifelse(test = (is.na(elsoc$m29)),#¿es el valor un NA?
                    yes = elsoc$mean_tramos, #Si es verdadero, remplazar por el valor de mean_tramos
                    no = elsoc$m29)# Si es falso, remplazar por el valor del m29

summary(elsoc$m29) # NA = 147

# cambiamos el nombre de las variables inghogar = m29; nhogar=nhogar1
elsoc <- dplyr::rename(elsoc, inghogar=m29, nhogar=nhogar1)
# ingreso neto = ingreso del hogar / numero de personas en el hogar
elsoc$ingneto   <- as.numeric(elsoc$inghogar/elsoc$nhogar)
# logaritmo natural del ingreso neto (para normalizar la distribucion sesgada del ingreso)
elsoc$lningneto <- log(elsoc$ingneto)

summary(elsoc$ingneto)
summary(elsoc$lningneto)

#---Deciles (ingreso per capita hogar)------------------------------------------------
elsoc <- elsoc %>% dplyr::mutate(inc10h = dplyr::ntile(inghogar, 10)) # Crear Deciles de ingreso
elsoc$D10h <- factor(elsoc$inc10h, levels = c(1,2,3,4,5,6,7,8,9,10),
                    labels = c("D01","D02","D03","D04","D05",
                               "D06","D07","D08","D09","D10"));table(elsoc$D10h)
```

### Educación

* [`m01`] = ¿Cuál es su nivel educacional? Indique el tipo de estudio actual (si estudia actualmente) o el último tipo aprobado (si no estudia actualmente). 

```{r}
table(elsoc$m01) # Educacion en ELSOC
sjmisc::frq(elsoc$m01)
```

**Recodificación [CINE 2011 (UNESCO)](http://uis.unesco.org/sites/default/files/documents/isced-2011-sp.pdf)**

```
1.  Sin	estudios                                = [CINE 0   ] =  1
2.  Educacion Basica o Preparatoria incompleta  = [CINE 0   ] =  1
3.  Educacion Basica o Preparatoria completa    = [CINE 1,2 ] =  2
4.  Educacion Media o Humanidades incompleta    = [CINE 3   ] =  3
5.  Educacion Media o Humanidades completa      = [CINE 3   ] =  3
6.  Tecnico Superior incompleta                 = [CINE 5   ] =  4
7.  Tecnico Superior completa                   = [CINE 5   ] =  4
8.  Universitaria incompleta                    = [CINE 6   ] =  5
9.  Universitaria completa                      = [CINE 6   ] =  6
10. Estudios de posgrado (magister o doctorado) = [CINE 7, 8] =  6
```

```{r}
# recodificacion usando funcion 'recode' de la libreria car
elsoc$edcine <- car::recode(elsoc$m01, "c(1,2)=1; c(3)=2;c(4,5)=3;c(6,7)=4;c(8,9,10)=5")
round(prop.table(table(elsoc$edcine)), 3)

elsoc$edcine <- factor(elsoc$edcine,
                       levels = c(1,2,3,4,5),
                       labels=c("Primaria incompleta menos",
                                "Primaria y secundaria baja",
                                "Secundaria alta",
                                "Terciaria ciclo corto",
                                "Terciaria y Postgrado"))

sjmisc::frq(elsoc$edcine) #chequeamos
```

## Variables control

* [`m0_sexo`]	=	Indicar el sexo del entrevistado.

* [`m0_edad`]	=	¿Cuáles su edad? (años cumplidos).

* [`c15`]    	=	Cambiando de tema, tradicionalmente en nuestro país la gente define las posiciones políticas como más cercanas a la izquierda, al centro o a la derecha. 

```{r}
#---Sexo----
elsoc$sexo <- car::recode(elsoc$m0_sexo, "1=1;2=0")
elsoc$sexo <- factor(elsoc$sexo, levels = c(0,1), labels = c("Hombre","Mujer")) # Sexo
#Hombre=0
#Mujer=1
sjmisc::frq(elsoc$sexo) #chequeamos 
#---Edad----
elsoc$edad <- as.numeric(elsoc$m0_edad) #Edad
summary(elsoc$edad) #chequeamos
#---Posicion Politica----
# PREGUNTA: "Autoubicacion escala izquierda-derecha"
  # (0 = izquierda; 10 = Derecha; 11 = Independiente; 12 =Ninguno)
elsoc$ppolcat  <- car::recode(elsoc$c15, "c(0,1,2,3,4)=1;5=2;c(6,7,8,9,10)=3;11=4;12=5")
elsoc$ppolcat  <- factor(elsoc$ppolcat, levels = c(1,2,3,4,5),
                         labels = c("Izquierda/Centro Izquierda",
                                    "Centro",
                                    "Derecha/Centro Derecha",
                                    "Independiente",
                                    "Ninguno"))
sjmisc::frq(elsoc$ppolcat) #chequeamos
```


# Mantener variables relevantes

En última instancia se crea un **subset** que contiene solo las variables que se van a utilizar en el análisis, mediante la función `select` de `dplyr.`

```{r}
# selecccionamos las variables relevantes
elsoc_16 <- elsoc %>% dplyr::select(merit,ess,edcine,lningneto,D10h, sexo, edad,ppolcat)
# dejamos solamente los casos con informacion completa (listwise deletion)
elsoc_16 <- na.omit(elsoc_16)
names(elsoc_16) # comprobamos los nombres de variables
head(elsoc_16) #chequear
```

```{r}
# Guardar base de datos procesada ---------------------------------------------------------------
save(elsoc_16,file = "data/proc/ELSOC_ess_merit2016.RData")
```
