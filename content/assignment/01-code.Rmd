---
title: "Práctica 1. Procesamiento de datos en R"
subtitle: "Estadistica Multivariada - Sociología FACSO Universidad de Chile"
linktitle: "Práctica 1"
date: "2020-01-10"
class_date: "2020-04-03"
citeproc: false
bibliography: ../../static/bib/references.bib
csl: ../../static/bib/chicago-syllabus-no-bib.csl
output:
  blogdown::html_page:
    template: ../../pandoc/toc-title_html.template
    toc: true
    highlight: tango
    number_sections: true
menu:
  class:
    parent: Practicas
    weight: 1
type: docs
weight: 1
editor_options:
  chunk_output_type: console
---

# Presentación

## Tutorial de instalación de R

Para quienes no trabajan en R constantemente, va un primer tutorial abajo sobre instalación de R y RStudio, necesarios para poder desarrollar esta práctica:

<iframe src=https://www.dropbox.com/s/q0jg4pv3ihtf2qd/tutorialR_editedjc.mp4?raw=1
 height="500" width="870">
</iframe>



## Antecedentes de los datos a utilizar

El Estudio Longitudinal Social de Chile [(ELSOC)](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/0KIRBJ) es una encuesta desarrollada para analizar intertemporalmente la evolución del conflicto y cohesión en la sociedad chilena.

Uno de los módulos de **ELSOC** es "Desigualdad y Legitimidad". Este módulo busca estudiar las percepciones y atribuciones asociadas a las desigualdades sociales. Se ve motivado por el interés de comprender cómo las personas perciben, legitiman y reproducen las diferencias de ingresos, estatus y poder presentes en el Chile contemporáneo.

El presente ejercicio tiene por objetivo el procesar los datos para obtener las variables relevante para el estudio de la **Percepción de Meritocracia**, entendida como el grado en que los individuos consideran que su sociedad cumple con los principios de una meritocracia, es decir, que funciona como un sistema que asigna recompensas en función del esfuerzo y las habilidades.

# Preparacion de datos con ELSOC 2016


## Librerías y configuración

```{r}
library(dplyr)
rm(list=ls()) # borrar todos los objetos en el enviorment
options(scipen=999) #sin notacion cientifica
```


### Cargar base de datos


```{r eval=FALSE}
load("https://multivariada.netlify.com/assignment/data/original/ELSOC_W01_v3.10.RData")
elsoc <- elsoc_2016; remove(elsoc_2016)

```


```{r echo=FALSE}
load("data/original/ELSOC_W01_v3.10.RData")
elsoc <- elsoc_2016; remove(elsoc_2016)
```

### Datos perdidos

* En ELSOC todos los valores -888 y -999 corresponden a valores para las categorias "No sabe" y "No responde", respectivamente.
* Decidimos dejarlas como valores perdidos (NA)
```{r}
for (i in 1:ncol(elsoc)) {
  elsoc[,i][elsoc[,i] == c(-888)]  <- NA #Missing
  elsoc[,i][elsoc[,i] == c(-999)]  <- NA #Missing
  }
```


## Recodificacion Variables percepcion de meritocracia

* [`c18_09`]: "Grado de acuerdo: Las personas son recompensadas por sus esfuerzos"  (1 = Totalmente en desacuerdo; 5 = Totalmente de acuerdo)
* [`c18_10`]: "Grado de acuerdo: Las personas son recompensada por su inteligencia" (1 = Totalmente en desacuerdo; 5 = Totalmente de acuerdo)

```{r}
elsoc$c18_09 <- as.numeric(elsoc$c18_09)
elsoc$c18_10 <- as.numeric(elsoc$c18_10)
# Variables meritocracia promedio -----------------------------------------
elsoc <- rename(elsoc,meffort=c18_09) # cambio de nombre de la variable c18_09 a uno mas sustantivo
elsoc <- rename(elsoc,mtalent=c18_10) # cambio de nombre de la variable c18_10 a uno mas sustantivo

# creamos un indice promedio de percepcion de meritocracia usando ambas preguntas
elsoc$merit <- (elsoc$meffort+elsoc$mtalent)/2

# re escalamos la variable de 1-5 a una de 0 a 100 (para facilitar interpretacion)
elsoc$merit <-
  (elsoc$merit-min(elsoc$merit,na.rm=T))/(max(elsoc$merit,na.rm=T)-min(elsoc$merit,na.rm=T))*100
```

## Recodificacion variable Estatus subjetivo

* [`d01_01`]: "Estatus Social Subjetivo: Donde se ubicaria ud. en la sociedad chilena" (0 = el nivel mas bajo; 10 = el nivel mas alto)

```{r, results='hold'}
elsoc$ess <- as.numeric(elsoc$d01_01) # Estatus Social Subjetivo
table(elsoc$ess)
summary(elsoc$ess)
```

## Recodificacion variables Estatus objetivo

### Ingresos del hogar

```{r}
summary(elsoc$m29) # ingresos total ; NA == 587
summary(elsoc$m30) # ingresos tramos
summary(elsoc$nhogar1) # tamannio del hogar

elsoc$m29[elsoc$m29==0] <- NA
# Remplazar NA por media de categorias Ingreso -------------------------------#
elsoc$mean_tramos <- NA # creamos una variable vacia
# remplazamos ...
elsoc$mean_tramos[elsoc$m30==1] <-110000
elsoc$mean_tramos[elsoc$m30==2] <-250000.5
elsoc$mean_tramos[elsoc$m30==3] <-305000.5
elsoc$mean_tramos[elsoc$m30==4] <-355000.5
elsoc$mean_tramos[elsoc$m30==5] <-400000.5
elsoc$mean_tramos[elsoc$m30==6] <-445000.5
elsoc$mean_tramos[elsoc$m30==7] <-490000.5
elsoc$mean_tramos[elsoc$m30==8] <-535000.5
elsoc$mean_tramos[elsoc$m30==9] <-585000.5
elsoc$mean_tramos[elsoc$m30==10]<-640000.5
elsoc$mean_tramos[elsoc$m30==11]<-700000.5
elsoc$mean_tramos[elsoc$m30==12]<-765000.5
elsoc$mean_tramos[elsoc$m30==13]<-845000.5
elsoc$mean_tramos[elsoc$m30==14]<-935000.5
elsoc$mean_tramos[elsoc$m30==15]<-1040000.5
elsoc$mean_tramos[elsoc$m30==16]<-1180000.5
elsoc$mean_tramos[elsoc$m30==17]<-1375000.5
elsoc$mean_tramos[elsoc$m30==18]<-1670000.5
elsoc$mean_tramos[elsoc$m30==19]<-2275000.5
elsoc$mean_tramos[elsoc$m30==20]<-3726106
table(elsoc$mean_tramos) # chequeamos

elsoc$m29 <- ifelse(test = (is.na(elsoc$m29)),#¿es el valor un NA?
                    yes = elsoc$mean_tramos, #Si es verdadero, remplazar por el valor de mean_tramos
                    no = elsoc$m29)# Si es falso, remplazar por el valor del m29

summary(elsoc$m29) # NA = 147

# cambiamos el nombre de las variables inghogar = m29; nhogar=nhogar1
elsoc <- rename(elsoc, inghogar=m29, nhogar=nhogar1)
# ingreso neto = ingreso del hogar / numero de personas en el hogar
elsoc$ingneto   <- as.numeric(elsoc$inghogar/elsoc$nhogar)
# logaritmo natural del ingreso neto (para normalizar la distribucion sesgada del ingreso)
elsoc$lningneto <- log(elsoc$ingneto)

summary(elsoc$ingneto)
summary(elsoc$lningneto)

#---Deciles (ingreso per capita hogar)------------------------------------------------
elsoc <- elsoc %>% mutate(inc10h = ntile(inghogar, 10)) # Crear Deciles de ingreso
elsoc$D10h <- factor(elsoc$inc10h, levels = c(1,2,3,4,5,6,7,8,9,10),
                    labels = c("D01","D02","D03","D04","D05",
                               "D06","D07","D08","D09","D10"));table(elsoc$D10h)
```

### Educación

```{r}
table(elsoc$m01) # Educacion en ELSOC
```

**Recodificación [CINE 2011 (UNESCO)](http://uis.unesco.org/sites/default/files/documents/isced-2011-sp.pdf)**

```
1.  Sin	estudios                                = [CINE 0   ] =  1
2.  Educacion Basica o Preparatoria incompleta  = [CINE 0   ] =  1
3.  Educacion Basica o Preparatoria completa    = [CINE 1,2 ] =  2
4.  Educacion Media o Humanidades incompleta    = [CINE 3   ] =  3
5.  Educacion Media o Humanidades completa      = [CINE 3   ] =  3
6.  Tecnico Superior incompleta                 = [CINE 5   ] =  4
7.  Tecnico Superior completa                   = [CINE 5   ] =  4
8.  Universitaria incompleta                    = [CINE 6   ] =  5
9.  Universitaria completa                      = [CINE 6   ] =  6
10. Estudios de posgrado (magister o doctorado) = [CINE 7, 8] =  6
```


```{r}
# recodificacion usando funcion 'recode' de la libreria car
elsoc$edcine <- car::recode(elsoc$m01, "c(1,2)=1; c(3)=2;c(4,5)=3;c(6,7)=4;c(8,9,10)=5")
round(prop.table(table(elsoc$edcine)), 3)

elsoc$edcine <- factor(elsoc$edcine,
                       levels = c(1,2,3,4,5),
                       labels=c("Primaria incompleta menos",
                                "Primaria y secundaria baja",
                                "Secundaria alta",
                                "Terciaria ciclo corto",
                                "Terciaria y Postgrado"))

table(elsoc$edcine) #chequeamos
```

## Variables control

```{r}
#---Sexo----
elsoc$sexo <- car::recode(elsoc$m0_sexo, "1=1;2=0")
elsoc$sexo <- factor(elsoc$sexo, levels = c(0,1), labels = c("Hombre","Mujer")) # Sexo
#Hombre=0
#Mujer=1

#---Edad----
elsoc$edad <- as.numeric(elsoc$m0_edad) #Edad

#---Posicion Politica----
# PREGUNTA: "Autoubicacion escala izquierda-derecha"
  # (0 = izquierda; 10 = Derecha; 11 = Independiente; 12 =Ninguno)
elsoc$ppolcat  <- car::recode(elsoc$c15, "c(0,1,2,3,4)=1;5=2;c(6,7,8,9,10)=3;11=4;12=5")
elsoc$ppolcat  <- factor(elsoc$ppolcat, levels = c(1,2,3,4,5),
                         labels = c("Izquierda/Centro Izquierda",
                                    "Centro",
                                    "Derecha/Centro Derecha",
                                    "Independiente",
                                    "Ninguno"))
```

# Mantener variables relevantes

```{r}
# selecccionamos las variables relevantes
elsoc_16 <- elsoc %>% dplyr::select(merit,ess,edcine,lningneto,D10h, sexo, edad,ppolcat)
# dejamos solamente los casos con informacion completa (listwise deletion)
elsoc_16 <- na.omit(elsoc_16)
names(elsoc_16) # comprobamos los nombres de variables
head(elsoc_16) #chequear
```

```{r}
# Guardar base de datos procesada ---------------------------------------------------------------
save(elsoc_16,file = "data/proc/ELSOC_ess_merit2016.RData")
```
