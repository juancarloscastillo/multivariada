---
title: "Práctica 1. Procesamiento de datos en R"
subtitle: "Estadistica Multivariada - Sociología FACSO Universidad de Chile"
linktitle: "Práctica 1"
date: "2020-01-10"
class_date: "2020-04-03"
citeproc: false
bibliography: ../../static/bib/references.bib
csl: ../../static/bib/chicago-syllabus-no-bib.csl
output:
  blogdown::html_page:
    template: ../../pandoc/toc-title_html.template
    toc: true
    highlight: tango
    number_sections: FALSE
menu:
  class:
    parent: Practicas
    weight: 1
type: docs
weight: 1
editor_options:
  chunk_output_type: console
---

# Presentación

## Objetivo de la práctica

El desarrollo de esta guía tiene por objetivo revisar algunos procedimientos básicos del procesamiento de datos con R, que son necesarios para luego poder aplicar los contenidos más específicos de este curso.

En este curso vamos a distinguir **dos momentos** del trabajo con datos: procesamiento y análisis.

  - **Procesamiento** corresponde a lo que se conoce generalmente como "limpieza", es decir, realizar las modificaciones necesarias para poder efectuar los análisis. Estas modificaciones previas al análisis son necesarias ya que los datos originales con los que se va a trabajar en general no vienen perfectamente adaptados a los análisis que se quieren hacer. Por lo tanto, en cuanto a datos también hacemos la distinción entre datos originales y datos procesados.

  - **Análisis**: se relaciona principalmente con análisis descriptivos asociados a las preguntas de investigación y también modelamiento de datos para contrastar hipótesis de investigación.

Tanto el procesamiento como el análisis quedan registrados en un documento de código, en este caso de código R (por lo general, un archivo con extensión .R). El documento de código de procesamiento posee 5 partes, más una sección de identificación inicial:

0. Identificación y descripción general: Título, autor(es), fecha, información breve sobre el contenido del documento
1. Librerías principales (de R) a utilizar en el análisis
2. Carga de datos
3. Selección de variables a utilizar
4. Procesamiento de variables: en este punto, por cada variable
  - Descriptivo general
  - Recodificación de datos perdidos
  - Recodificación de valores (en caso de ser necesario)
  - Etiquetamiento /re-etiquetamiento (en caso de ser necesario)
5. Generación de base de datos procesada para el análisis.

Al final de esta práctica la idea es que cada un_ elabore y entienda su propio documento de procesamiento de datos.

En el ejemplo vamos a procesar variables de meritocracia y estatus (objetivo y subjetivo) utilizando los datos de ELSOC.

## Antecedentes de los datos a utilizar

El Estudio Longitudinal Social de Chile [(ELSOC)](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/0KIRBJ) es una encuesta desarrollada para analizar intertemporalmente la evolución del conflicto y cohesión en la sociedad chilena.

Uno de los módulos de **ELSOC** es "Desigualdad y Legitimidad". Este módulo busca estudiar las percepciones y atribuciones asociadas a las desigualdades sociales. Se ve motivado por el interés de comprender cómo las personas perciben, legitiman y reproducen las diferencias de ingresos, estatus y poder presentes en el Chile contemporáneo.

El presente ejercicio tiene por objetivo el procesar los datos para obtener las variables relevante para el estudio de la **Percepción de Meritocracia**, entendida como el grado en que los individuos consideran que su sociedad cumple con los principios de una meritocracia, es decir, que funciona como un sistema que asigna recompensas en función del esfuerzo y las habilidades.

## Tutorial de instalación de R

Para quienes no trabajan en R constantemente, va un primer tutorial abajo sobre instalación de R y RStudio, necesarios para poder desarrollar esta práctica:

<div style="width: 100%; height: 600px; overflow: hidden;">
<video  style="width: 100%;" controls>
<source src="https://www.dropbox.com/s/q0jg4pv3ihtf2qd/tutorialR_editedjc.mp4?raw=1" type="video/mp4">
</video>
</div>


# Preparacion de datos con ELSOC 2016

## 1. Librerías principales (de R) a utilizar en el análisis

Las librerías que vamos a utilizar principalmente son `dplyr` (ajuste general de datos), `sjmisc` (descripción y exploración de base de datos) y `car` (principalmente la función `recode` para recodificar/agrupar valores de variable). Una de las ventajas de utilizar R, es la posibilidad de emplear distintas librería. No obstante, para este ejercicio se ha decidido reducir al máximo el uso de librerías para evitar confusiones con el objetivo de que la lectura del código sea lo más intuitivo posible. Para el caso de las librerías, se recomienda utilizar el signo **`#`** para comentar y dejar en claro el contenido/función que cumplirá cada una de éstas en nuestro trabajo. 

**Por ejemplo:**
```{r message=FALSE, warning=FALSE}
library(dplyr)      # Ajuste general de datos
library(sjmisc)     # Descripcion de variables etiquetadas  
library(car)        # Recodificacion de variables
```

## 2. Cargar base de datos


**Espacio de trabajo**

Previo a la carga de nuestra base de datos, ejecutamos las siguientes líneas:

```{r}
rm(list=ls())       # borrar todos los objetos en el espacio de trabajo
options(scipen=999) # valores sin notacion cientifica
```

La función `rm(list=ls())` permite comenzar con un espacio de trabajo (environment) vacío y sin otros objetos. Así también, la función `options(scipen=999)` desactiva la notación científica, es decir, veremos los valores numéricos con todos sus decimales.

**Datos**

Las bases de datos se pueden cargar de un archivo local o en línea. Para este caso utilizaremos un archivo en línea que viene en formato RData: **ELSOC_W01_v3.10.RData**.

La base se agrega como un objeto al espacio de trabajo con el nombre original "`elsoc_2016`". Para facilitar los análisis se le cambia el nombre simplemente a `elsoc` con la segunda instrucción

```{r eval=TRUE}
#cargamos la base de datos desde internet
load(url("https://multivariada.netlify.com/assignment/data/original/ELSOC_W01_v3.10.RData")) 
#creamos un objeto llamado elsoc que es identico a elsoc_2016, luego eliminamos elsoc_2016
elsoc <- elsoc_2016; remove(elsoc_2016) 
```

Y realizamos un chequeo básico de la lectura de datos: nombres de las variables y tamaño de la base en términos de casos y variables (en este ejemplo, `r dim(elsoc)[1]` casos y `r dim(elsoc)[2]` variables).

```{r}
dim(elsoc) # dimension de la base
```
Y si se quiere revisar en formato de planilla de datos:

```{r}
View(elsoc)
```


## 3. Selección de variables a utilizar

Esta parte inicial del análisis es usualmente la más tediosa y la más larga, y consiste en dejar los datos listos para ser analizados. Los procedimientos usuales son selección y renombramiento de las variables, identificación de casos perdidos, recodificaciones y generación de índices simples.


Este paso es opcional y consiste en crear un subset de datos para continuar con los análisis, en lugar de hacerlo con la base completa. Para ello:

1. Se identifica el nombre de las variables. Esto aparece en el libro de códigos y/o en el cuestionario, o también se puede hacer buscando en la base de datos mediante alguna palabra clave asociada a la pregunta. Por ejemplo, si queremos buscar variables asociadas a educación, utilizamos la función `find_var`, de `sjmisc` (entrega nombre de la variable en columna var.name)

```{r}
sjmisc::find_var(data = elsoc,"educacional")
sjmisc::find_var(data = elsoc,"Ingreso")
```

Mediante la función `select` de `dplyr`, seleccionamos cada una de nuestras variables de interés.

```{r}
elsoc <- elsoc %>% select(c18_09, # meritocracia esfuerzo
                          c18_10, # meritocracia talento
                          d01_01, # estatus social subjetivo
                          m29,    # ingreso familiar 
                          m30,    # ingreso familiar en tramos
                          nhogar1,# personas en el hogar
                          m01,    # nivel educacional
                          m0_sexo,# sexo
                          m0_edad,# edad
                          c15)    # autoposicionamiento eje izquierda-derecha
```


## 4. Procesamiento de variables

**Introducción**

En el caso de trabajar con R, el ajuste de las variables pasa por atender el distinto tipo de estructura, usualmente numérico (vector) o variable categórica (factor). Esta definición establece diferencias claras; por ejemplo, no se puede hacer un promedio con un factor, y los vectores númericos no tienen etiquetas. Dado que el límite entre lo categórico y lo continuo muchas veces es más relativo en ciencias sociales, para algunas operaciones resulta más eficiente contar con variables numéricas que puedan tener etiquetas, y que luego puedan ser transformadas a factor para operaciones específicas. En R este formato intermedio se denomina "vector atómico" o "vector etiquetado".

```{r}
str(elsoc)
```


En este caso, vemos que los diez vectores se definen como "numeric", pero que además podemos observar otra serie de atributos que hacen referencia a vectores numéricos etiquetados. Esto ocurre en el proceso de conversión mediante el paquete `haven` que transforma de esta manera a los valores numéricos con etiqueta que vienen de Stata (.dta) o SPSS (.sav). Esto se debe a que la base de datos fue previamente procesada empleando este paquete, para luego ser guardada en formato `.RData`.

Los vectores que que aparecen aquí se caracterizan por una serie de atributos (attr):

- **label:** etiqueta de la variable
- **format.stata:** formato de la etiqueta de la variable
- **labels**: niveles de respuesta de la variable (values) que están numerados
- **names:** nombre de las etiquetas de los valores.

Estos atributos luego van a facilitar algunas operaciones de recodificación y de descripción de los datos.

**Datos perdidos** 

En ELSOC todos los valores -888 y -999 corresponden a valores para las categorias "No sabe" y "No responde", respectivamente. Para efecto de este ejercicio, hemos decidimos dejarlas como valores perdidos (`NA`)

En el ejemplo de posible observar el uso del operador `%in%`, el cual nos permite  decir "dentro de". En este caso, ¿es posible encontrar valores -888 o -999 dentro de nuestra variavle? Si es VERDADERO, se procede a remplazar dicho valor por un `NA`, si es FALSO no se realiza ningún procedimiento.

```{r, include=TRUE, eval=FALSE}
datos$variable[datos$variable %in% c(-888,-999)] <- NA
```


### A. Recodificacion Variables percepcion de meritocracia

En ELSOC, las variables que permiten medir la percepción de las personas con respecto al funcionamiento de la meritocracia en Chile son las siguientes:

* [`c18_09`]: "Grado de acuerdo: Las personas son recompensadas por sus esfuerzos" (1 = Totalmente en desacuerdo; 5 = Totalmente de acuerdo)
* [`c18_10`]: "Grado de acuerdo: Las personas son recompensada por su inteligencia" (1 = Totalmente en desacuerdo; 5 = Totalmente de acuerdo)

1. Descriptivo general

```{r}
summary(elsoc$c18_09)
summary(elsoc$c18_10)
```

2. Recodificación de datos perdidos

```{r}
elsoc$c18_09[elsoc$c18_09 %in% c(-888,-999)]  <- NA  
elsoc$c18_10[elsoc$c18_10 %in% c(-888,-999)]  <- NA  
```

3. Creación de variable promedio

**Nos aseguramos de convertir las escalas likert a numericas**
```{r}
elsoc$c18_09<-  as.numeric(elsoc$c18_09) 
elsoc$c18_10<-  as.numeric(elsoc$c18_10) 
```

**Variable índice promedio percepción de meritocracia**
```{r}
# creamos un indice promedio de percepcion de meritocracia usando ambas preguntas
elsoc$merit <- (elsoc$c18_09+elsoc$c18_10)/2

# re escalamos la variable de 1-5 a una de 0 a 100 (para facilitar interpretacion)
elsoc$merit <-
  (elsoc$merit-min(elsoc$merit,na.rm=T))/(max(elsoc$merit,na.rm=T)-min(elsoc$merit,na.rm=T))*100
summary(elsoc$merit)
```

4. Renombrar variables

```{r}
elsoc <- elsoc %>% rename("mesfuerzo"=c18_09, # meritocracia esfuerzo
                          "mtalento" =c18_10, # meritocracia talento
                          "pmerit"   =merit)  # meritocracia promedio
```

### B. Recodificacion variable Estatus subjetivo

* [`d01_01`]: "Estatus Social Subjetivo: Donde se ubicaria ud. en la sociedad chilena" (0 = el nivel mas bajo; 10 = el nivel mas alto)

1. Descriptivo general

```{r, results='hold'}
sjmisc::frq(elsoc$d01_01)
summary(elsoc$d01_01)
```

2. Recodificación de datos perdidos

```{r}
elsoc$d01_01[elsoc$d01_01 %in% c(-888,-999)]  <- NA  
```

**Nos aseguramos de convertir la variable a numérica**
```{r}
elsoc$d01_01 <- as.numeric(elsoc$d01_01) 
```

3. Renombrar variable

```{r}
elsoc <- elsoc %>% rename("ess"=d01_01) # estatus social subjetivo
```

### C. Recodificacion variables Estatus objetivo

#### C.1.Ingresos del hogar

Esta variable en general tiene dos formas de preguntarse: en el monto directo en pesos, o en rangos de ingreso. Hay una tercera variante donde se pregunta por el monto directo, y quienes no responden luego se les pregunta por el rango. Este último es el caso de ELSOC. 

* [`m29`] = ¿Cuál es el ingreso mensual que usted recibe por su actividad laboral, ocupación u oficio? (Ingreso líquido, es decir, después de descuentos de impuestos, salud, previsión u otros)
* [`m30`] = A continuación le presentamos un listado de rangos de ingreso. ¿Podría usted indicarme en cuál de ellos se encuentra considerando su ingreso líquido, es decir, su ingreso después de descuentos de impuestos, salud, previsión u otros?
* [`nhogar1`] = Tamaño del hogar (en número de personas)

Como estas variables en general tienen muchos datos perdidos, para poder aprovechar la información lo ideal es combinarlas. Una posibilidad es la siguiente:

* Crear una variable de ingresos en pesos a partir de la pregunta de rangos, mediante la imputación del promedio del rango.
* Combinar las variables de ingreso 
(`m30` $\rightarrow$ `m29`)
* Para tener mayor sensibilidad a las implicancias del ingreso, crear una variable de ingreso equivalente por hogar, dividiendo la variable de ingreso por el número de personas del hogar ((`m29`+`m30`)/`nhogar1`).


1. Descriptivos

```{r}
summary(elsoc$m29)     # ingresos total
sjmisc::frq(elsoc$m30) # ingresos tramos
summary(elsoc$nhogar1) # tamannio del hogar
```

2. Recodificación de datos perdidos

```{r}
elsoc$m29[elsoc$m29 %in% c(-888,-999)]      <- NA  
elsoc$m30[elsoc$m30 %in% c(-888,-999)]      <- NA  
elsoc$nhogar1[elsoc$nhogar1 %in% c(-888,-999)]  <- NA  
```

3. Recodificación de valores 

**Promedio de cada tramo de ingreso** 

```{r}
# Remplazar NA por media de categorias Ingreso -------------------------------#
# remplazamos ...
elsoc$m30[elsoc$m30==1] <-110000
elsoc$m30[elsoc$m30==2] <-250000.5
elsoc$m30[elsoc$m30==3] <-305000.5
elsoc$m30[elsoc$m30==4] <-355000.5
elsoc$m30[elsoc$m30==5] <-400000.5
elsoc$m30[elsoc$m30==6] <-445000.5
elsoc$m30[elsoc$m30==7] <-490000.5
elsoc$m30[elsoc$m30==8] <-535000.5
elsoc$m30[elsoc$m30==9] <-585000.5
elsoc$m30[elsoc$m30==10]<-640000.5
elsoc$m30[elsoc$m30==11]<-700000.5
elsoc$m30[elsoc$m30==12]<-765000.5
elsoc$m30[elsoc$m30==13]<-845000.5
elsoc$m30[elsoc$m30==14]<-935000.5
elsoc$m30[elsoc$m30==15]<-1040000.5
elsoc$m30[elsoc$m30==16]<-1180000.5
elsoc$m30[elsoc$m30==17]<-1375000.5
elsoc$m30[elsoc$m30==18]<-1670000.5
elsoc$m30[elsoc$m30==19]<-2275000.5
elsoc$m30[elsoc$m30==20]<-3726106
table(elsoc$m30) # chequeamos
```

**Remplazamos los NA de `m29` por los valores de `m30`**

* En el caso de que en `m29` no exista dato, se remplaza por el valor del promedio del tramo de ingreso en la variable `m30`.

```{r}
elsoc$m29 <- ifelse(test = (is.na(elsoc$m29)), # ¿es el valor un NA?
                    yes = elsoc$m30,           # Si es VERDADERO, remplazar por el valor de m30
                    no = elsoc$m29)            # Si es FALSO, remplazar por el valor del m29
```

4. Creación de variables nuevas

**Ingreso neto = ingreso del hogar / numero de personas en el hogar**
```{r}
elsoc$ingneto   <- as.numeric(elsoc$m29/elsoc$nhogar1)
```

**Logaritmo natural del ingreso neto (para normalizar la distribucion sesgada del ingreso)**

Con la función `log` una variable logaritmizada de ingreso según la variable `ingneto`, la cual llamaremos `lningneto`.
```{r}
elsoc$lningneto <- log(elsoc$ingneto)
```

**En base a la variable `ingneto`, podemos crear los deciles (ingreso per capita hogar)**

Con la función `ntile` de `dplyr` creamos los deciles de ingreso según la variable `ingneto`, la cual llamaremos `inc10h`.
```{r}
elsoc$inc10h <-  dplyr::ntile(elsoc$ingneto, 10) # Crear Deciles de ingreso
```

5. Etiquetamiento 

**Deciles ingreso del hogar**
```{r}
elsoc$D10h <- factor(elsoc$inc10h, 
                     levels = c(1,2,3,4,5,6,7,8,9,10),
                     labels = c("D01","D02","D03","D04","D05","D06","D07","D08","D09","D10"))
```

#### C.2. Educación

* [`m01`] = ¿Cuál es su nivel educacional? Indique el tipo de estudio actual (si estudia actualmente) o el último tipo aprobado (si no estudia actualmente). 

1. Descriptivo general
```{r}
sjmisc::frq(elsoc$m01)
```

2. Recodificación de datos perdidos
```{r}
elsoc$m01[elsoc$m01 %in% c(-888,-999)]      <- NA  
```

3. Recodificación de valores

**Recodificación [CINE 2011 (UNESCO)](http://uis.unesco.org/sites/default/files/documents/isced-2011-sp.pdf)**

```
1.  Sin	estudios                                = [CINE 0   ] =  1
2.  Educacion Basica o Preparatoria incompleta  = [CINE 0   ] =  1
3.  Educacion Basica o Preparatoria completa    = [CINE 1,2 ] =  2
4.  Educacion Media o Humanidades incompleta    = [CINE 3   ] =  3
5.  Educacion Media o Humanidades completa      = [CINE 3   ] =  3
6.  Tecnico Superior incompleta                 = [CINE 5   ] =  4
7.  Tecnico Superior completa                   = [CINE 5   ] =  4
8.  Universitaria incompleta                    = [CINE 6   ] =  5
9.  Universitaria completa                      = [CINE 6   ] =  6
10. Estudios de posgrado (magister o doctorado) = [CINE 7, 8] =  6
```
```{r}
# recodificacion usando funcion 'recode' de la libreria car
elsoc$m01 <- car::recode(elsoc$m01, "c(1,2)=1; c(3)=2;c(4,5)=3;c(6,7)=4;c(8,9,10)=5")
```

4. Etiquetamiento 

```{r}
elsoc$m01 <- factor(elsoc$m01,
                    levels = c(1,2,3,4,5),
                    labels=c("Primaria incompleta menos",
                             "Primaria y secundaria baja",
                             "Secundaria alta",
                             "Terciaria ciclo corto",
                             "Terciaria y Postgrado"))
```

5. Renombrar variable

```{r}
elsoc <- rename(elsoc,"edcine"=m01)
```


### D. Variables control

* [`m0_sexo`]	=	Indicar el sexo del entrevistado.

* [`m0_edad`]	=	¿Cuáles su edad? (años cumplidos).

* [`c15`]    	=	Cambiando de tema, tradicionalmente en nuestro país la gente define las posiciones políticas como más cercanas a la izquierda, al centro o a la derecha.  (0 = izquierda; 10 = Derecha; 11 = Independiente; 12 =Ninguno)


1. Descriptivo general

```{r}
sjmisc::frq(elsoc$m0_sexo)
summary(elsoc$m0_edad)
sjmisc::frq(elsoc$c15)
```

2. Recodificación de datos perdidos

```{r}
elsoc$m0_sexo[elsoc$m0_sexo %in% c(-888,-999)] <- NA  
elsoc$m0_edad[elsoc$m0_edad %in% c(-888,-999)] <- NA  
elsoc$c15[elsoc$c15 %in% c(-888,-999)]         <- NA  
```


3. Recodificación de valores

```{r}
elsoc$m0_sexo <- car::recode(elsoc$m0_sexo, "1=1;2=0")
elsoc$c15  <- car::recode(elsoc$c15, "c(0,1,2,3,4)=1;5=2;c(6,7,8,9,10)=3;11=4;12=5")
```

4. Etiquetamiento

```{r}
elsoc$m0_sexo <- factor(elsoc$m0_sexo, levels = c(0,1), labels = c("Hombre","Mujer")) 
elsoc$c15  <- factor(elsoc$c15, levels = c(1,2,3,4,5),
                         labels = c("Izquierda/Centro Izquierda",
                                    "Centro",
                                    "Derecha/Centro Derecha",
                                    "Independiente",
                                    "Ninguno"))
```

5. Renombrar variables

```{r}
elsoc <- dplyr::rename(elsoc,"sexo"=m0_sexo,
                             "edad"=m0_edad,
                             "ppolcat"=c15)
```


# 5. Generación de base de datos procesada para el análisis

En última instancia se crea un **subset** que contiene solo las variables que se van a utilizar en el análisis, mediante la función `select` de `dplyr.`

```{r}
# selecccionamos las variables relevantes
elsoc_16 <- elsoc %>% dplyr::select(pmerit,ess,edcine,lningneto,D10h,sexo,edad,ppolcat)
```

Dejamos solamente los casos con informacion completa (listwise deletion) usando la función `na.omit()`

```{r}
elsoc_16 <- na.omit(elsoc_16)
```

**Revisión final:**
```{r}
names(elsoc_16) # Nombre de variable 
head(elsoc_16)  # chequear
```

**Guardar base de datos procesada** 

```{r}
save(elsoc_16,file = "data/proc/ELSOC_ess_merit2016.RData")
```
